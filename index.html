<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudan Border Flow Monitoring Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .dashboard-title {
            margin: 0;
        }
        .summary-cards {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .card {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 1;
            margin: 0 10px;
            min-width: 200px;
            text-align: center;
        }
        .card h3 {
            color: #7f8c8d;
            margin-top: 0;
        }
        .card p {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        .dashboard-section {
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-title {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 10px;
        }
        #map {
            height: 500px;
            width: 100%;
            border-radius: 5px;
        }
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .chart-wrapper {
            width: 48%;
            min-width: 300px;
            margin-bottom: 20px;
        }
        canvas {
            width: 100% !important;
            height: 300px !important;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #7f8c8d;
        }
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        select, input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        @media (max-width: 768px) {
            .summary-cards {
                flex-direction: column;
            }
            .card {
                margin: 10px 0;
            }
            .chart-wrapper {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="dashboard-title">Sudan Border Flow Monitoring Dashboard</h1>
            <p>Tracking population movements at border points</p>
        </header>

        <div class="summary-cards">
            <div class="card">
                <h3>Total Inflow</h3>
                <p id="total-inflow">0</p>
            </div>
            <div class="card">
                <h3>Total Outflow</h3>
                <p id="total-outflow">0</p>
            </div>
            <div class="card">
                <h3>Active Border Points</h3>
                <p id="active-points">0</p>
            </div>
            <div class="card">
                <h3>Primary Neighboring Country</h3>
                <p id="primary-country">-</p>
            </div>
        </div>

        <div class="filter-controls">
            <div>
                <label for="date-filter">Date Range:</label>
                <input type="date" id="start-date">
                <input type="date" id="end-date">
            </div>
            <div>
                <label for="border-filter">Border Point:</label>
                <select id="border-filter">
                    <option value="all">All Border Points</option>
                </select>
            </div>
            <div>
                <label for="country-filter">Neighboring Country:</label>
                <select id="country-filter">
                    <option value="all">All Countries</option>
                </select>
            </div>
        </div>

        <div class="dashboard-section">
            <h2 class="section-title">Border Points Map</h2>
            <div id="map"></div>
        </div>

        <div class="dashboard-section">
            <h2 class="section-title">Flow Direction Analysis</h2>
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="flowDirectionChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="nationalityChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="genderChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="transportChart"></canvas>
                </div>
            </div>
        </div>

        <div class="dashboard-section">
            <h2 class="section-title">Recent Border Crossings</h2>
            <div id="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Border Point</th>
                            <th>Neighboring Country</th>
                            <th>Direction</th>
                            <th>Total</th>
                            <th>Sudanese</th>
                            <th>Non-Sudanese</th>
                            <th>Male</th>
                            <th>Female</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr>
                            <td colspan="9" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allData = [];
        let map;
        let flowDirectionChart, nationalityChart, genderChart, transportChart;
        let borderMarkers = [];

        // Initialize the dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            initializeCharts();
            fetchData();
            setupEventListeners();
        });

        // Initialize the map
        function initializeMap() {
            map = L.map('map').setView([15.5, 30.0], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        // Initialize empty charts
        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw.toLocaleString()}`;
                            }
                        }
                    }
                }
            };

            // Flow Direction Chart
            const flowDirectionCtx = document.getElementById('flowDirectionChart').getContext('2d');
            flowDirectionChart = new Chart(flowDirectionCtx, {
                type: 'bar',
                data: {
                    labels: ['Inflow', 'Outflow'],
                    datasets: [{
                        label: 'Number of People',
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of People'
                            }
                        }
                    }
                }
            });

            // Nationality Chart
            const nationalityCtx = document.getElementById('nationalityChart').getContext('2d');
            nationalityChart = new Chart(nationalityCtx, {
                type: 'pie',
                data: {
                    labels: ['Sudanese', 'Non-Sudanese'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });

            // Gender Chart
            const genderCtx = document.getElementById('genderChart').getContext('2d');
            genderChart = new Chart(genderCtx, {
                type: 'pie',
                data: {
                    labels: ['Male', 'Female'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });

            // Transport Chart
            const transportCtx = document.getElementById('transportChart').getContext('2d');
            transportChart = new Chart(transportCtx, {
                type: 'bar',
                data: {
                    labels: ['On Foot', 'Private Vehicle', 'Public Transport', 'Goods Vehicle', 'Other'],
                    datasets: [{
                        label: 'Number of People',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(255, 159, 64, 0.7)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of People'
                            }
                        }
                    }
                }
            });
        }

        // Fetch data from the API
        async function fetchData() {
            try {
                const response = await fetch('https://kf.kobo.iom.int/assets/arcZXQHEepmPYNq4BaTKUa/submissions/?format=json');
                const data = await response.json();
                allData = processData(data);
                updateDashboard(allData);
                updateFilters(allData);
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('table-body').innerHTML = '<tr><td colspan="9">Error loading data. Please try again later.</td></tr>';
            }
        }

        // Process raw API data
        function processData(rawData) {
            return rawData.map(item => {
                // Extract coordinates
                let lat, lon;
                if (item['_start_gps_latitude'] && item['_start_gps_longitude']) {
                    lat = parseFloat(item['_start_gps_latitude']);
                    lon = parseFloat(item['_start_gps_longitude']);
                } else if (item['1.4 GPS coordinates']) {
                    const coords = item['1.4 GPS coordinates'].split(',').map(coord => parseFloat(coord.trim()));
                    if (coords.length === 2) {
                        lat = coords[0];
                        lon = coords[1];
                    }
                }

                // Process transport data
                const incomingTransport = {
                    onFoot: parseInt(item['2.2 What type of transport was used to cross? (select all that apply)/On foot or animal cart'] || '0'),
                    privateVehicle: parseInt(item['2.2 What type of transport was used to cross? (select all that apply)/Private or rented vehicle (car, taxi..)'] || '0'),
                    publicTransport: parseInt(item['2.2 What type of transport was used to cross? (select all that apply)/Public transport (bus, mini-bus)'] || '0'),
                    goodsVehicle: parseInt(item['2.2 What type of transport was used to cross? (select all that apply)/Goods vehicle (truck, tractor, lorry)'] || '0'),
                    other: parseInt(item['2.2 What type of transport was used to cross? (select all that apply)/Other'] || '0')
                };

                const outgoingTransport = {
                    onFoot: parseInt(item['5.2 What type of transport was used to cross? (select all that apply)/On foot or animal cart'] || '0'),
                    privateVehicle: parseInt(item['5.2 What type of transport was used to cross? (select all that apply)/Private or rented vehicle (car, taxi..)'] || '0'),
                    publicTransport: parseInt(item['5.2 What type of transport was used to cross? (select all that apply)/Public transport (bus, mini-bus)'] || '0'),
                    goodsVehicle: parseInt(item['5.2 What type of transport was used to cross? (select all that apply)/Goods vehicle (truck, tractor, lorry)'] || '0'),
                    other: parseInt(item['5.2 What type of transport was used to cross? (select all that apply)/Other'] || '0')
                };

                return {
                    id: item._id,
                    date: item['1.7 Date of data collection'] || item.today || 'Unknown date',
                    state: item['1.1 State of FMP'] || 'Unknown state',
                    locality: item['1.2 Locality of FMP'] || 'Unknown locality',
                    borderPoint: item['1.3 Flow Monitoring Point'] || 'Unknown point',
                    neighboringCountry: item['1.5 Neighbouring country'] || 'Unknown country',
                    enumerator: item['1.6 Enumerator Name'] || 'Unknown enumerator',
                    direction: item['1.8 Direction of Movement'] || 'Unknown',
                    coordinates: lat && lon ? [lat, lon] : null,
                    
                    // Incoming data
                    incomingTotal: parseInt(item['2.1 What is the total number of people crossing?'] || '0'),
                    incomingSudanese: parseInt(item['3.1 Number of Sudanese individuals'] || '0'),
                    incomingNonSudanese: parseInt(item['3.2 Number of non-Sudanese individuals'] || '0'),
                    incomingMale: parseInt(item['4.1 Male'] || '0'),
                    incomingFemale: parseInt(item['4.2 Female'] || '0'),
                    incomingTransport: incomingTransport,
                    
                    // Outgoing data
                    outgoingTotal: parseInt(item['5.1 What is the total number of people crossing?'] || '0'),
                    outgoingSudanese: parseInt(item['6.1 Number of Sudanese individuals'] || '0'),
                    outgoingNonSudanese: parseInt(item['6.2 Number of non-Sudanese individuals'] || '0'),
                    outgoingMale: parseInt(item['7.1 Male'] || '0'),
                    outgoingFemale: parseInt(item['7.2 Female'] || '0'),
                    outgoingTransport: outgoingTransport,
                    
                    submissionTime: item._submission_time
                };
            });
        }

        // Update the dashboard with filtered data
        function updateDashboard(data) {
            if (data.length === 0) {
                document.getElementById('table-body').innerHTML = '<tr><td colspan="9">No data available for the selected filters.</td></tr>';
                return;
            }

            // Calculate totals
            const totalInflow = data.reduce((sum, item) => sum + item.incomingTotal, 0);
            const totalOutflow = data.reduce((sum, item) => sum + item.outgoingTotal, 0);
            
            // Count unique border points
            const borderPoints = new Set(data.map(item => item.borderPoint));
            
            // Find most common neighboring country
            const countryCounts = {};
            data.forEach(item => {
                countryCounts[item.neighboringCountry] = (countryCounts[item.neighboringCountry] || 0) + 1;
            });
            const primaryCountry = Object.keys(countryCounts).reduce((a, b) => 
                countryCounts[a] > countryCounts[b] ? a : b, 'N/A');

            // Update summary cards
            document.getElementById('total-inflow').textContent = totalInflow.toLocaleString();
            document.getElementById('total-outflow').textContent = totalOutflow.toLocaleString();
            document.getElementById('active-points').textContent = borderPoints.size;
            document.getElementById('primary-country').textContent = primaryCountry;

            // Update charts
            updateCharts(data);
            
            // Update map
            updateMap(data);
            
            // Update data table
            updateDataTable(data);
        }

        // Update charts with filtered data
        function updateCharts(data) {
            // Flow direction data
            const inflowTotal = data.reduce((sum, item) => sum + item.incomingTotal, 0);
            const outflowTotal = data.reduce((sum, item) => sum + item.outgoingTotal, 0);
            flowDirectionChart.data.datasets[0].data = [inflowTotal, outflowTotal];
            flowDirectionChart.update();

            // Nationality data
            const sudaneseTotal = data.reduce((sum, item) => sum + item.incomingSudanese + item.outgoingSudanese, 0);
            const nonSudaneseTotal = data.reduce((sum, item) => sum + item.incomingNonSudanese + item.outgoingNonSudanese, 0);
            nationalityChart.data.datasets[0].data = [sudaneseTotal, nonSudaneseTotal];
            nationalityChart.update();

            // Gender data
            const maleTotal = data.reduce((sum, item) => sum + item.incomingMale + item.outgoingMale, 0);
            const femaleTotal = data.reduce((sum, item) => sum + item.incomingFemale + item.outgoingFemale, 0);
            genderChart.data.datasets[0].data = [maleTotal, femaleTotal];
            genderChart.update();

            // Transport data
            const transportData = {
                onFoot: 0,
                privateVehicle: 0,
                publicTransport: 0,
                goodsVehicle: 0,
                other: 0
            };

            data.forEach(item => {
                if (item.incomingTransport) {
                    transportData.onFoot += item.incomingTransport.onFoot;
                    transportData.privateVehicle += item.incomingTransport.privateVehicle;
                    transportData.publicTransport += item.incomingTransport.publicTransport;
                    transportData.goodsVehicle += item.incomingTransport.goodsVehicle;
                    transportData.other += item.incomingTransport.other;
                }
                if (item.outgoingTransport) {
                    transportData.onFoot += item.outgoingTransport.onFoot;
                    transportData.privateVehicle += item.outgoingTransport.privateVehicle;
                    transportData.publicTransport += item.outgoingTransport.publicTransport;
                    transportData.goodsVehicle += item.outgoingTransport.goodsVehicle;
                    transportData.other += item.outgoingTransport.other;
                }
            });

            transportChart.data.datasets[0].data = [
                transportData.onFoot,
                transportData.privateVehicle,
                transportData.publicTransport,
                transportData.goodsVehicle,
                transportData.other
            ];
            transportChart.update();
        }

        // Update map with filtered data
        function updateMap(data) {
            // Clear existing markers
            borderMarkers.forEach(marker => map.removeLayer(marker));
            borderMarkers = [];

            // Add new markers
            const borderPoints = {};
            
            data.forEach(item => {
                if (!item.coordinates) return;
                
                const key = `${item.coordinates[0]},${item.coordinates[1]}`;
                if (!borderPoints[key]) {
                    borderPoints[key] = {
                        coordinates: item.coordinates,
                        borderPoint: item.borderPoint,
                        incomingTotal: 0,
                        outgoingTotal: 0
                    };
                }
                
                borderPoints[key].incomingTotal += item.incomingTotal;
                borderPoints[key].outgoingTotal += item.outgoingTotal;
            });

            Object.values(borderPoints).forEach(point => {
                const popupContent = `
                    <b>${point.borderPoint}</b><br>
                    Inflow: ${point.incomingTotal.toLocaleString()}<br>
                    Outflow: ${point.outgoingTotal.toLocaleString()}
                `;
                
                const marker = L.marker(point.coordinates)
                    .addTo(map)
                    .bindPopup(popupContent);
                
                borderMarkers.push(marker);
            });

            // Fit map to show all markers if there are any
            if (borderMarkers.length > 0) {
                const group = new L.featureGroup(borderMarkers);
                map.fitBounds(group.getBounds());
            }
        }

        // Update data table with filtered data
        function updateDataTable(data) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9">No data available for the selected filters.</td></tr>';
                return;
            }

            // Sort by date (newest first)
            const sortedData = [...data].sort((a, b) => 
                new Date(b.date) - new Date(a.date));

            sortedData.forEach(item => {
                const row = document.createElement('tr');
                
                // Determine direction and totals
                let direction, total, sudanese, nonSudanese, male, female;
                
                if (item.direction.includes('Incoming')) {
                    direction = 'Incoming';
                    total = item.incomingTotal;
                    sudanese = item.incomingSudanese;
                    nonSudanese = item.incomingNonSudanese;
                    male = item.incomingMale;
                    female = item.incomingFemale;
                } else if (item.direction.includes('Outgoing')) {
                    direction = 'Outgoing';
                    total = item.outgoingTotal;
                    sudanese = item.outgoingSudanese;
                    nonSudanese = item.outgoingNonSudanese;
                    male = item.outgoingMale;
                    female = item.outgoingFemale;
                } else {
                    direction = 'Unknown';
                    total = 0;
                    sudanese = 0;
                    nonSudanese = 0;
                    male = 0;
                    female = 0;
                }

                row.innerHTML = `
                    <td>${item.date || 'Unknown'}</td>
                    <td>${item.borderPoint || 'Unknown'}</td>
                    <td>${item.neighboringCountry || 'Unknown'}</td>
                    <td>${direction}</td>
                    <td>${total.toLocaleString()}</td>
                    <td>${sudanese.toLocaleString()}</td>
                    <td>${nonSudanese.toLocaleString()}</td>
                    <td>${male.toLocaleString()}</td>
                    <td>${female.toLocaleString()}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Update filter dropdowns based on available data
        function updateFilters(data) {
            const borderFilter = document.getElementById('border-filter');
            const countryFilter = document.getElementById('country-filter');
            
            // Get unique border points and countries
            const borderPoints = [...new Set(data.map(item => item.borderPoint).filter(Boolean)];
            const countries = [...new Set(data.map(item => item.neighboringCountry).filter(Boolean))];
            
            // Update border point filter
            borderPoints.forEach(point => {
                const option = document.createElement('option');
                option.value = point;
                option.textContent = point;
                borderFilter.appendChild(option);
            });
            
            // Update country filter
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
            
            // Set default date range to last 30 days
            const dates = data.map(item => new Date(item.date)).filter(date => !isNaN(date.getTime()));
            if (dates.length > 0) {
                const maxDate = new Date(Math.max(...dates));
                const minDate = new Date(Math.min(...dates));
                
                const endDate = new Date(maxDate);
                const startDate = new Date(maxDate);
                startDate.setDate(startDate.getDate() - 30);
                
                // Ensure start date doesn't go before earliest data
                if (startDate < minDate) {
                    startDate.setTime(minDate.getTime());
                }
                
                document.getElementById('start-date').valueAsDate = startDate;
                document.getElementById('end-date').valueAsDate = endDate;
            }
        }

        // Filter data based on selected filters
        function filterData() {
            const startDate = document.getElementById('start-date').valueAsDate;
            const endDate = document.getElementById('end-date').valueAsDate;
            const borderPoint = document.getElementById('border-filter').value;
            const country = document.getElementById('country-filter').value;
            
            let filteredData = [...allData];
            
            // Filter by date
            if (startDate && endDate) {
                filteredData = filteredData.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= startDate && itemDate <= endDate;
                });
            }
            
            // Filter by border point
            if (borderPoint !== 'all') {
                filteredData = filteredData.filter(item => item.borderPoint === borderPoint);
            }
            
            // Filter by country
            if (country !== 'all') {
                filteredData = filteredData.filter(item => item.neighboringCountry === country);
            }
            
            updateDashboard(filteredData);
        }

        // Set up event listeners for filters
        function setupEventListeners() {
            document.getElementById('start-date').addEventListener('change', filterData);
            document.getElementById('end-date').addEventListener('change', filterData);
            document.getElementById('border-filter').addEventListener('change', filterData);
            document.getElementById('country-filter').addEventListener('change', filterData);
        }
    </script>
</body>
</html>
