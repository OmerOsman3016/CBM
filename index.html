<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <title>Sudan Population Distribution</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f7fa;
      color: #333;
    }
    
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .map-container {
      background-color: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }
    
    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .map-header h2 {
      margin: 0;
      color: #2A6FBB;
      font-size: 22px;
    }
    
    .population-toggle {
      display: flex;
      background: #f0f0f0;
      border-radius: 6px;
      overflow: hidden;
      flex-wrap: wrap;
    }
    
    .population-toggle .toggle-btn {
      border: none;
      padding: 8px 16px;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #555;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .population-toggle .toggle-btn.active {
      background: #2A6FBB;
      color: white;
    }
    
    .population-toggle .toggle-btn:first-child {
      border-radius: 6px 0 0 6px;
    }
    
    .population-toggle .toggle-btn:last-child {
      border-radius: 0 6px 6px 0;
    }
    
    /* Key Metrics Panel Styles */
    .key-metrics-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      background: #f8fafc;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .metric-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.2s ease;
    }
    
    .metric-card:hover {
      transform: translateY(-3px);
    }
    
    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: #2A6FBB;
      margin-bottom: 5px;
    }
    
    .metric-label {
      font-size: 14px;
      color: #64748b;
    }
    
    #population-distribution-map {
      width: 100%;
      height: 70vh;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    .info {
      padding: 10px;
      background: white;
      border-radius: 5px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    
    .info h4 {
      margin: 0 0 5px;
      color: #2A6FBB;
      font-size: 16px;
    }
    
    .population-legend {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      line-height: 1.5;
    }
    
    .population-legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
    
    .population-legend h4 {
      margin: 0 0 10px;
      color: #2A6FBB;
      font-size: 15px;
      font-weight: 600;
    }
    
    .map-loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      font-size: 16px;
      color: #333;
    }
    
    @media (max-width: 768px) {
      .map-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .population-toggle {
        width: 100%;
      }
      
      .key-metrics-panel {
        grid-template-columns: 1fr 1fr;
      }
      
      #population-distribution-map {
        height: 60vh;
      }
    }
    
    @media (max-width: 480px) {
      .key-metrics-panel {
        grid-template-columns: 1fr;
      }
      
      #population-distribution-map {
        height: 50vh;
      }
    }
  </style>
</head>

<body>
  <div class="main-container">
    <div class="map-container">
      <div class="map-header">
        <h2>Population Distribution by State</h2>
        <div class="population-toggle">
          <button class="toggle-btn active" data-type="idps">IDPs</button>
          <button class="toggle-btn" data-type="returnees">Returnees</button>
          <button class="toggle-btn" data-type="foreign_nationals">Foreign Nationals</button>
        </div>
      </div>
      
      <!-- Key Metrics Panel -->
      <div class="key-metrics-panel">
        <div class="metric-card">
          <div class="metric-value" id="total-idps">0</div>
          <div class="metric-label">Total IDPs</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="total-returnees">0</div>
          <div class="metric-label">Total Returnees</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="total-foreign">0</div>
          <div class="metric-label">Foreign Nationals</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="affected-states">0</div>
          <div class="metric-label">Affected States</div>
        </div>
      </div>
      
      <div id="population-distribution-map"></div>
      <div id="map-loading" class="map-loading">Loading map data...</div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  
  <script>
    // Initialize the map when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Show loading state
      const loadingElement = document.getElementById('map-loading');
      if (loadingElement) loadingElement.style.display = 'flex';
      
      // Initialize the map
      const populationMap = L.map('population-distribution-map').setView([16, 30], 5);
      
      // Add the base layer
      const mapboxCustom = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
      }).addTo(populationMap);
      
      // Define multiple base layers for the map
      const cartoDBLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      });
      
      const openStreetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      });
      
      const esriWorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
      });
      
      // Add layer control
      const baseLayers = {
        "Mapbox Custom": mapboxCustom,
        "CartoDB Light": cartoDBLight,
        "OpenStreetMap": openStreetMap,
        "Esri World Imagery": esriWorldImagery
      };
      
      L.control.layers(baseLayers).addTo(populationMap);
      
      // Sample data - in a real application, this would come from an API or JSON file
      const sudanStatesData = {
        "type": "FeatureCollection",
        "features": [
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "North Darfur",
              "total_idps": 1234567,
              "total_returnees": 0,
              "total_foreign_nationals": 0
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for North Darfur */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "South Darfur",
              "total_idps": 2345678,
              "total_returnees": 0,
              "total_foreign_nationals": 0
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for South Darfur */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "West Darfur",
              "total_idps": 876543,
              "total_returnees": 8765,
              "total_foreign_nationals": 0
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for West Darfur */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "East Darfur",
              "total_idps": 567890,
              "total_returnees": 0,
              "total_foreign_nationals": 0
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for East Darfur */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "Central Darfur",
              "total_idps": 456789,
              "total_returnees": 0,
              "total_foreign_nationals": 0
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for Central Darfur */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "Khartoum",
              "total_idps": 456789,
              "total_returnees": 6789,
              "total_foreign_nationals": 7890
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for Khartoum */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "Aj Jazirah",
              "total_idps": 789012,
              "total_returnees": 889012,
              "total_foreign_nationals": 7890
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for Aj Jazirah */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "White Nile",
              "total_idps": 678901,
              "total_returnees": 78901,
              "total_foreign_nationals": 8901
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for White Nile */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "Blue Nile",
              "total_idps": 345678,
              "total_returnees": 0,
              "total_foreign_nationals": 9012
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for Blue Nile */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "Sennar",
              "total_idps": 234567,
              "total_returnees": 34567,
              "total_foreign_nationals": 0
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for Sennar */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "Kassala",
              "total_idps": 123456,
              "total_returnees": 23456,
              "total_foreign_nationals": 2345
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for Kassala */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "Red Sea",
              "total_idps": 98765,
              "total_returnees": 8765,
              "total_foreign_nationals": 3456
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for Red Sea */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "Northern",
              "total_idps": 87654,
              "total_returnees": 7654,
              "total_foreign_nationals": 0
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for Northern */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "River Nile",
              "total_idps": 76543,
              "total_returnees": 0,
              "total_foreign_nationals": 678
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for River Nile */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "North Kordofan",
              "total_idps": 654321,
              "total_returnees": 0,
              "total_foreign_nationals": 0
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for North Kordofan */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "South Kordofan",
              "total_idps": 543210,
              "total_returnees": 0,
              "total_foreign_nationals": 0
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for South Kordofan */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "West Kordofan",
              "total_idps": 432109,
              "total_returnees": 0,
              "total_foreign_nationals": 0
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for West Kordofan */]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "admin1Name_en": "Gedaref",
              "total_idps": 321098,
              "total_returnees": 0,
              "total_foreign_nationals": 9012
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[/* coordinates for Gedaref */]]
            }
          }
        ]
      };
      
      // Current data type (IDPs, Returnees, or Foreign Nationals)
      let currentDataType = 'idps';
      
      // Define color functions based on population type
      function getColorForIDPs(d) {
        return d > 1000000 ? '#084594' :
               d > 500000  ? '#2171b5' :
               d > 200000  ? '#4292c6' :
               d > 100000  ? '#6baed6' :
               d > 50000   ? '#9ecae1' :
               d > 20000   ? '#c6dbef' :
                             '#eff3ff';
      }
      
      function getColorForReturnees(d) {
        // Use RGB(255, 137, 82) for returnees with different opacities
        return d > 1000000 ? 'rgba(255, 137, 82, 0.9)' :
               d > 500000  ? 'rgba(255, 137, 82, 0.8)' :
               d > 200000  ? 'rgba(255, 137, 82, 0.7)' :
               d > 100000  ? 'rgba(255, 137, 82, 0.6)' :
               d > 50000   ? 'rgba(255, 137, 82, 0.5)' :
               d > 20000   ? 'rgba(255, 137, 82, 0.4)' :
                             'rgba(255, 137, 82, 0.3)';
      }
      
      function getColorForForeignNationals(d) {
        // Use RGB(0, 196, 148) for foreign nationals with different opacities
        return d > 1000000 ? 'rgba(0, 196, 148, 0.9)' :
               d > 500000  ? 'rgba(0, 196, 148, 0.8)' :
               d > 200000  ? 'rgba(0, 196, 148, 0.7)' :
               d > 100000  ? 'rgba(0, 196, 148, 0.6)' :
               d > 50000   ? 'rgba(0, 196, 148, 0.5)' :
               d > 20000   ? 'rgba(0, 196, 148, 0.4)' :
                             'rgba(0, 196, 148, 0.3)';
      }
      
      // Main color function that selects the appropriate palette
      function getColor(d) {
        switch(currentDataType) {
          case 'idps':
            return getColorForIDPs(d);
          case 'returnees':
            return getColorForReturnees(d);
          case 'foreign_nationals':
            return getColorForForeignNationals(d);
          default:
            return getColorForIDPs(d);
        }
      }
      
      // Define style function
      function style(feature) {
        return {
          fillColor: getColor(feature.properties[`total_${currentDataType}`] || 0),
          weight: 2,
          opacity: 1,
          color: 'white',
          dashArray: '3',
          fillOpacity: 0.7
        };
      }
      
      // Add hover interactions
      function highlightFeature(e) {
        const layer = e.target;
        
        layer.setStyle({
          weight: 5,
          color: '#666',
          dashArray: '',
          fillOpacity: 0.7
        });
        
        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
          layer.bringToFront();
        }
        
        info.update(layer.feature.properties);
      }
      
      function resetHighlight(e) {
        geojsonLayer.resetStyle(e.target);
        info.update();
      }
      
      function zoomToFeature(e) {
        populationMap.fitBounds(e.target.getBounds());
      }
      
      function onEachFeature(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight,
          click: zoomToFeature
        });
      }
      
      // Add GeoJSON layer
      let geojsonLayer = L.geoJSON(sudanStatesData, {
        style: style,
        onEachFeature: onEachFeature
      }).addTo(populationMap);
      
      // Fit map to bounds of all features
      populationMap.fitBounds(geojsonLayer.getBounds());
      
      // Add info control
      const info = L.control();
      
      info.onAdd = function(map) {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
      };
      
      info.update = function(props) {
        let title, valueLabel;
        
        switch(currentDataType) {
          case 'idps':
            title = 'IDP Distribution';
            valueLabel = 'IDPs';
            break;
          case 'returnees':
            title = 'Returnee Distribution';
            valueLabel = 'Returnees';
            break;
          case 'foreign_nationals':
            title = 'Foreign Nationals Distribution';
            valueLabel = 'Foreign Nationals';
            break;
        }
        
        this._div.innerHTML = `<h4>Sudan ${title}</h4>` + 
          (props ? 
            `<b>${props.admin1Name_en}</b><br />` + 
            (props[`total_${currentDataType}`] || 0).toLocaleString() + 
            ` ${valueLabel}` : 
            'Hover over a state');
      };
      
      info.addTo(populationMap);
      
      // Function to update map display based on selected data type
      function updateMapDisplay(dataType) {
        currentDataType = dataType;
        
        // Update the legend
        if (legend) {
          legend.remove();
          legend.addTo(populationMap);
        }
        
        // Update the style and info display
        geojsonLayer.setStyle(feature => {
          const value = feature.properties[`total_${dataType}`] || 0;
          return {
            fillColor: getColor(value),
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.7
          };
        });
        
        // Update the info control function
        info.update = function(props) {
          let title, valueLabel;
          
          switch(dataType) {
            case 'idps':
              title = 'IDP Distribution';
              valueLabel = 'IDPs';
              break;
            case 'returnees':
              title = 'Returnee Distribution';
              valueLabel = 'Returnees';
              break;
            case 'foreign_nationals':
              title = 'Foreign Nationals Distribution';
              valueLabel = 'Foreign Nationals';
              break;
          }
          
          this._div.innerHTML = `<h4>Sudan ${title}</h4>` + 
            (props ? 
              `<b>${props.admin1Name_en}</b><br />` + 
              (props[`total_${dataType}`] || 0).toLocaleString() + 
              ` ${valueLabel}` : 
              'Hover over a state');
        };
        
        // Trigger an update for the info control
        info.update();
      }
      
      // Add toggle buttons functionality
      const toggleButtons = document.querySelectorAll('.population-toggle .toggle-btn');
      toggleButtons.forEach(button => {
        button.addEventListener('click', () => {
          // Remove active class from all buttons
          toggleButtons.forEach(btn => btn.classList.remove('active'));
          // Add active class to the clicked button
          button.classList.add('active');
          // Update the map display
          updateMapDisplay(button.dataset.type);
        });
      });
      
      // Add legend control
      const legend = L.control({position: 'bottomright'});
      
      legend.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'info legend population-legend');
        let grades, title, colorFunc;
        
        switch(currentDataType) {
          case 'idps':
            grades = [0, 20000, 50000, 100000, 200000, 500000, 1000000];
            title = 'IDPs';
            colorFunc = getColorForIDPs;
            break;
          case 'returnees':
            grades = [0, 20000, 50000, 100000, 200000, 500000, 1000000];
            title = 'Returnees';
            colorFunc = getColorForReturnees;
            break;
          case 'foreign_nationals':
            grades = [0, 20000, 50000, 100000, 200000, 500000, 1000000];
            title = 'Foreign Nationals';
            colorFunc = getColorForForeignNationals;
            break;
        }
        
        div.innerHTML = `<h4>${title}</h4>`;
        
        // Loop through population intervals and generate a label with a colored square for each interval
        for (let i = 0; i < grades.length; i++) {
          div.innerHTML +=
            '<i style="background:' + colorFunc(grades[i] + 1) + '"></i> ' +
            grades[i].toLocaleString() + (grades[i + 1] ? '&ndash;' + grades[i + 1].toLocaleString() + '<br>' : '+');
        }
        
        return div;
      };
      
      legend.addTo(populationMap);
      
      // Calculate totals for the metrics panel
      function calculateTotals() {
        let totalIDPs = 0;
        let totalReturnees = 0;
        let totalForeign = 0;
        let affectedStates = 0;
        
        sudanStatesData.features.forEach(feature => {
          totalIDPs += feature.properties.total_idps || 0;
          totalReturnees += feature.properties.total_returnees || 0;
          totalForeign += feature.properties.total_foreign_nationals || 0;
          
          if (feature.properties.total_idps > 0 || 
              feature.properties.total_returnees > 0 || 
              feature.properties.total_foreign_nationals > 0) {
            affectedStates++;
          }
        });
        
        return {
          totalIDPs,
          totalReturnees,
          totalForeign,
          affectedStates
        };
      }
      
      // Update the metrics panel with calculated totals
      function updateMetricsPanel() {
        const totals = calculateTotals();
        
        document.getElementById('total-idps').textContent = totals.totalIDPs.toLocaleString();
        document.getElementById('total-returnees').textContent = totals.totalReturnees.toLocaleString();
        document.getElementById('total-foreign').textContent = totals.totalForeign.toLocaleString();
        document.getElementById('affected-states').textContent = totals.affectedStates;
      }
      
      // Update the metrics panel with initial data
      updateMetricsPanel();
      
      // Hide loading state
      if (loadingElement) loadingElement.style.display = 'none';
    });
  </script>
</body>
</html>
