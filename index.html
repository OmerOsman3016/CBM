<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow">
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="./css/styles.css">

  <!-- External JS -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js" defer></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" defer></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js" defer></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js" defer></script>
  <script src="./src/CanvasFlowmapLayer.js" defer></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" defer></script>
</head>

<body>
  <!-- Content will be dynamically added by JavaScript -->
</body>
</html>

<script>
// Population Distribution Map Module
const PopulationDistributionMap = (() => {
  // Configuration constants
  const CONFIG = {
    mapView: [16, 30],
    mapZoom: 5.5,
    mobileZoom: 3,
    colorSchemes: {
      idps: ['#eff3ff', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#084594'],
      returnees: Array(7).fill('rgba(255, 137, 82, ${opacity})').map((color, i) => 
        color.replace('${opacity}', (0.3 + i * 0.1).toFixed(1))),
      foreign_nationals: Array(7).fill('rgba(0, 196, 148, ${opacity})').map((color, i) => 
        color.replace('${opacity}', (0.3 + i * 0.1).toFixed(1)))
    },
    populationRanges: [0, 20000, 50000, 100000, 200000, 500000, 1000000],
    mapboxStyle: 'https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q',
    baseLayers: {
      "Mapbox Custom": {
        url: 'https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q',
        options: {
          attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          tileSize: 512,
          zoomOffset: -1,
          maxZoom: 18
        }
      },
      "CartoDB Light": {
        url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
        options: {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }
      },
      "OpenStreetMap": {
        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        options: {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }
      },
      "Esri World Imagery": {
        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        options: {
          attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
        }
      }
    }
  };

  // State variables
  let state = {
    currentDataType: 'idps',
    populationMap: null,
    geojsonLayer: null,
    infoControl: null,
    legendControl: null
  };

  // DOM Elements
  const elements = {
    get mapContainer() {
      return document.getElementById('population-distribution-map-container') || createMapContainer();
    },
    get loadingElement() {
      return document.getElementById('map-loading');
    }
  };

  // Helper functions
  const helpers = {
    formatNumber: num => num.toLocaleString(),
    getColor: (value, dataType) => {
      const ranges = CONFIG.populationRanges;
      const colors = CONFIG.colorSchemes[dataType];
      
      for (let i = 0; i < ranges.length - 1; i++) {
        if (value <= ranges[i + 1]) return colors[i];
      }
      return colors[colors.length - 1];
    },
    calculateTotals: features => {
      const totals = {
        totalIDPs: 0,
        totalReturnees: 0,
        totalForeign: 0,
        affectedStates: 0
      };

      features.forEach(feature => {
        totals.totalIDPs += feature.properties.total_idps || 0;
        totals.totalReturnees += feature.properties.total_returnees || 0;
        totals.totalForeign += feature.properties.total_foreign_nationals || 0;
        
        if (feature.properties.total_idps > 0 || 
            feature.properties.total_returnees > 0 || 
            feature.properties.total_foreign_nationals > 0) {
          totals.affectedStates++;
        }
      });

      return totals;
    }
  };

  // DOM creation functions
  function createMapContainer() {
    const container = document.createElement('div');
    container.id = 'population-distribution-map-container';
    container.className = 'maps-container';
    container.style.cssText = 'opacity: 0; transform: translateY(20px); animation: slideUp 0.8s ease-in-out forwards 0.8s';
    
    container.innerHTML = `
      <div id="population-distribution-map-wrapper">
        <div class="map-header">
          <h2>Population Distribution by State</h2>
          <div class="population-toggle">
            <button class="toggle-btn active" data-type="idps">IDPs</button>
            <button class="toggle-btn" data-type="returnees">Returnees</button>
            <button class="toggle-btn" data-type="foreign_nationals">Foreign Nationals</button>
          </div>
        </div>
        
        <div class="key-metrics-panel">
          <div class="metric-card">
            <div class="metric-value" id="total-idps">0</div>
            <div class="metric-label">Total IDPs</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="total-returnees">0</div>
            <div class="metric-label">Total Returnees</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="total-foreign">0</div>
            <div class="metric-label">Foreign Nationals</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="affected-states">0</div>
            <div class="metric-label">Affected States</div>
          </div>
        </div>
        
        <div id="population-distribution-map"></div>
        <div id="map-loading" class="map-loading">Loading map data...</div>
      </div>
    `;

    // Insert container into DOM
    const idpsSection = document.getElementById('idps-section');
    if (idpsSection?.nextSibling) {
      idpsSection.parentNode.insertBefore(container, idpsSection.nextSibling);
    } else {
      document.querySelector('.main-container')?.appendChild(container);
    }

    addStyles();
    return container;
  }

  function addStyles() {
    const style = document.createElement('style');
    style.textContent = `
      #population-distribution-map-container {
        margin-bottom: 20px;
      }
      
      #population-distribution-map-wrapper {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      
      #population-distribution-map {
        width: 100%;
        height: 80vh;
        border-radius: 8px;
      }
      
      .map-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 15px;
      }
      
      .population-toggle {
        display: flex;
        background: #f0f0f0;
        border-radius: 6px;
        overflow: hidden;
        flex-wrap: wrap;
      }
      
      .population-toggle .toggle-btn {
        border: none;
        padding: 8px 16px;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #555;
        transition: all 0.3s ease;
      }
    
      .population-toggle .toggle-btn.active {
        background: #2A6FBB;
        color: white;
      }
      
      .key-metrics-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
        background: #f8fafc;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }
      
      .metric-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: transform 0.2s ease;
      }
      
      .metric-card:hover {
        transform: translateY(-3px);
      }
      
      .metric-value {
        font-size: 24px;
        font-weight: 700;
        color: #2A6FBB;
        margin-bottom: 5px;
      }
      
      .metric-label {
        font-size: 14px;
        color: #64748b;
      }
      
      .map-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        font-size: 16px;
        color: #333;
      }
      
      .info, .population-legend {
        padding: 10px;
        background: white;
        border-radius: 5px;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
      }
      
      .population-legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
      }
      
      @media (max-width: 768px) {
        .map-header {
          flex-direction: column;
          align-items: flex-start;
        }
        
        .population-toggle {
          width: 100%;
        }
        
        .key-metrics-panel {
          grid-template-columns: 1fr 1fr;
        }
      }
      
      @media (max-width: 480px) {
        .key-metrics-panel {
          grid-template-columns: 1fr;
        }
        
        #population-distribution-map {
          height: 60vh;
        }
      }
    `;
    document.head.appendChild(style);
  }

  // Map interaction functions
  function highlightFeature(e) {
    const layer = e.target;
    layer.setStyle({
      weight: 5,
      color: '#666',
      dashArray: '',
      fillOpacity: 0.7
    });
    
    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
      layer.bringToFront();
    }
    
    state.infoControl.update(layer.feature.properties);
  }

  function resetHighlight(e) {
    state.geojsonLayer.resetStyle(e.target);
    state.infoControl.update();
  }

  function zoomToFeature(e) {
    state.populationMap.fitBounds(e.target.getBounds());
  }

  function onEachFeature(feature, layer) {
    layer.on({
      mouseover: highlightFeature,
      mouseout: resetHighlight,
      click: zoomToFeature
    });
  }

  // Map update functions
  function updateMapStyle() {
    state.geojsonLayer.setStyle(feature => {
      const value = feature.properties[`total_${state.currentDataType}`] || 0;
      return {
        fillColor: helpers.getColor(value, state.currentDataType),
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
      };
    });
  }

  function updateInfoControl() {
    const titles = {
      idps: 'IDP Distribution',
      returnees: 'Returnee Distribution',
      foreign_nationals: 'Foreign Nationals Distribution'
    };
    
    const labels = {
      idps: 'IDPs',
      returnees: 'Returnees',
      foreign_nationals: 'Foreign Nationals'
    };

    state.infoControl.update = function(props) {
      this._div.innerHTML = `<h4>Sudan ${titles[state.currentDataType]}</h4>` + 
        (props ? 
          `<b>${props.state}</b><br />${helpers.formatNumber(props[`total_${state.currentDataType}`] || 0)} ${labels[state.currentDataType]}` : 
          'Hover over a state');
    };
    
    state.infoControl.update();
  }

  function updateLegend() {
    if (state.legendControl) {
      state.legendControl.remove();
    }

    state.legendControl = L.control({position: 'bottomright'});
    
    state.legendControl.onAdd = function() {
      const div = L.DomUtil.create('div', 'info legend population-legend');
      const titles = {
        idps: 'IDPs',
        returnees: 'Returnees',
        foreign_nationals: 'Foreign Nationals'
      };
      
      div.innerHTML = `<h4>${titles[state.currentDataType]}</h4>`;
      
      for (let i = 0; i < CONFIG.populationRanges.length; i++) {
        div.innerHTML +=
          '<i style="background:' + helpers.getColor(CONFIG.populationRanges[i] + 1, state.currentDataType) + '"></i> ' +
          helpers.formatNumber(CONFIG.populationRanges[i]) + 
          (CONFIG.populationRanges[i + 1] ? '&ndash;' + helpers.formatNumber(CONFIG.populationRanges[i + 1]) + '<br>' : '+');
      }
      
      return div;
    };
    
    state.legendControl.addTo(state.populationMap);
  }

  function updateMetricsPanel(features) {
    const totals = helpers.calculateTotals(features);
    
    document.getElementById('total-idps').textContent = helpers.formatNumber(totals.totalIDPs);
    document.getElementById('total-returnees').textContent = helpers.formatNumber(totals.totalReturnees);
    document.getElementById('total-foreign').textContent = helpers.formatNumber(totals.totalForeign);
    document.getElementById('affected-states').textContent = totals.affectedStates;
  }

  function updateMapDisplay(dataType) {
    state.currentDataType = dataType;
    updateMapStyle();
    updateInfoControl();
    updateLegend();
  }

  // Event handlers
  function setupToggleButtons() {
    const toggleButtons = document.querySelectorAll('.population-toggle .toggle-btn');
    
    toggleButtons.forEach(button => {
      button.addEventListener('click', () => {
        toggleButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        updateMapDisplay(button.dataset.type);
      });
    });
  }

  // Main initialization function
  async function init() {
    try {
      console.log("Initializing Population Distribution Map");
      
      // Show loading state
      if (elements.loadingElement) {
        elements.loadingElement.style.display = 'flex';
      }
      
      // Load GeoJSON data
      const response = await fetch('./data/ADMIN1.json');
      if (!response.ok) throw new Error(`Failed to load GeoJSON data: ${response.status}`);
      
      const sudanStatesData = await response.json();
      
      // Sample population data - in a real app, this would come from your data source
      const populationData = {
        "North Darfur": { idps: 1234567, returnees: 0, foreign_nationals: 0 },
        "South Darfur": { idps: 2345678, returnees: 0, foreign_nationals: 0 },
        "West Darfur": { idps: 876543, returnees: 8765, foreign_nationals: 0 },
        "East Darfur": { idps: 567890, returnees: 0, foreign_nationals: 0 },
        "Central Darfur": { idps: 456789, returnees: 0, foreign_nationals: 0 },
        "Khartoum": { idps: 456789, returnees: 6789, foreign_nationals: 7890 },
        "Aj Jazirah": { idps: 789012, returnees: 889012, foreign_nationals: 7890 },
        "White Nile": { idps: 678901, returnees: 78901, foreign_nationals: 8901 },
        "Blue Nile": { idps: 345678, returnees: 0, foreign_nationals: 9012 },
        "Sennar": { idps: 234567, returnees: 34567, foreign_nationals: 0 },
        "Kassala": { idps: 123456, returnees: 23456, foreign_nationals: 2345 },
        "Red Sea": { idps: 98765, returnees: 8765, foreign_nationals: 3456 },
        "Northern": { idps: 87654, returnees: 7654, foreign_nationals: 0 },
        "River Nile": { idps: 76543, returnees: 0, foreign_nationals: 678 },
        "North Kordofan": { idps: 654321, returnees: 0, foreign_nationals: 0 },
        "South Kordofan": { idps: 543210, returnees: 0, foreign_nationals: 0 },
        "West Kordofan": { idps: 432109, returnees: 0, foreign_nationals: 0 },
        "Gedaref": { idps: 321098, returnees: 0, foreign_nationals: 9012 }
      };
      
      // Merge population data with GeoJSON features
      sudanStatesData.features.forEach(feature => {
        const stateName = feature.properties.admin1Name_en;
        const data = populationData[stateName] || {};
        
        feature.properties = {
          ...feature.properties,
          total_idps: data.idps || 0,
          total_returnees: data.returnees || 0,
          total_foreign_nationals: data.foreign_nationals || 0,
          state: stateName || 'Unknown'
        };
      });
      
      // Initialize the map
      state.populationMap = L.map('population-distribution-map').setView(
        CONFIG.mapView, 
        L.Browser.mobile ? CONFIG.mobileZoom : CONFIG.mapZoom
      );
      
      // Add base layers
      const baseLayers = {};
      Object.entries(CONFIG.baseLayers).forEach(([name, layer]) => {
        baseLayers[name] = L.tileLayer(layer.url, layer.options).addTo(
          name === "Mapbox Custom" ? state.populationMap : null
        );
      });
      
      // Add layer control
      L.control.layers(baseLayers).addTo(state.populationMap);
      
      // Add GeoJSON layer
      state.geojsonLayer = L.geoJSON(sudanStatesData, {
        style: feature => ({
          fillColor: helpers.getColor(feature.properties[`total_${state.currentDataType}`] || 0, state.currentDataType),
          weight: 2,
          opacity: 1,
          color: 'white',
          dashArray: '3',
          fillOpacity: 0.7
        }),
        onEachFeature: onEachFeature
      }).addTo(state.populationMap);
      
      // Fit map to bounds
      state.populationMap.fitBounds(state.geojsonLayer.getBounds());
      
      // Add info control
      state.infoControl = L.control();
      state.infoControl.onAdd = function() {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
      };
      state.infoControl.addTo(state.populationMap);
      
      // Initialize controls
      updateInfoControl();
      updateLegend();
      updateMetricsPanel(sudanStatesData.features);
      setupToggleButtons();
      
      // Hide loading state
      if (elements.loadingElement) {
        elements.loadingElement.style.display = 'none';
      }
      
      console.log("Population Distribution Map initialized successfully");
      
    } catch (error) {
      console.error("Error initializing Population Distribution Map:", error);
      const mapElement = document.getElementById('population-distribution-map');
      if (mapElement) {
        mapElement.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">Error loading map data. Please try again later.</p>';
      }
      
      if (elements.loadingElement) {
        elements.loadingElement.style.display = 'none';
      }
    }
  }

  // Public API
  return {
    init
  };
})();

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', PopulationDistributionMap.init);
</script>
