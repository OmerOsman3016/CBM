<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <meta name="description" content="Sudan Displacement Dashboard" />
  <title>Sudan Displacement Dashboard</title>
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- External JS -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
 
  <style>
    :root {
      --primary-color: #4361ee;
      --primary-light: #eef2ff;
      --secondary-color: #f72585;
      --secondary-light: #fff0f6;
      --tertiary-color: #4cc9f0;
      --tertiary-light: #f0f9ff;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --light-gray: #f8fafc;
      --medium-gray: #e2e8f0;
      --dark-gray: #64748b;
      --darker-gray: #334155;
      --text-color: #1e293b;
      --border-radius: 12px;
      --border-radius-sm: 8px;
      --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --header-height: 80px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: #f1f5f9;
      color: var(--text-color);
      line-height: 1.6;
      height: 100vh;
      overflow: hidden;
    }

    /* Header styles */
    .app-header {
      background-color: white;
      padding: 0 30px;
      box-shadow: var(--box-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      position: relative;
      height: var(--header-height);
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logo-container img {
      height: 40px;
    }
    
    .app-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin: 0;
    }
    
    .app-subtitle {
      font-size: 0.9rem;
      color: var(--dark-gray);
      font-weight: 400;
      margin-top: 4px;
    }
    
    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    /* Main content layout */
    .main-container {
      display: flex;
      height: calc(100vh - var(--header-height));
    }
    
    /* Sidebar content */
    .sidebar-content {
      width: 420px;
      background-color: white;
      padding: 25px;
      border-right: 1px solid var(--medium-gray);
      overflow-y: auto;
      z-index: 10;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    /* Dashboard Sections */
    .dashboard-section {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      border: 1px solid var(--medium-gray);
      overflow: hidden;
    }
    
    .section-header {
      padding: 18px 20px;
      background: var(--light-gray);
      border-bottom: 1px solid var(--medium-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--darker-gray);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-title i {
      font-size: 1rem;
      color: var(--primary-color);
    }
    
    .section-content {
      padding: 20px;
    }
    
    /* Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .metric-card {
      background: var(--light-gray);
      border-radius: var(--border-radius-sm);
      padding: 18px 15px;
      text-align: center;
      transition: var(--transition);
    }
    
    .metric-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    .metric-card .label {
      font-size: 14px;
      color: var(--dark-gray);
      font-weight: 500;
    }
    
    .metric-card .value {
      font-size: 24px;
      font-weight: 700;
      margin: 8px 0;
    }
    
    .metric-card .sub-value {
      font-size: 13px;
      color: var(--dark-gray);
    }
    
    .metric-card .change {
      font-size: 12px;
      margin-top: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    
    /* Specific metric colors */
    .idps-metric {
      border-top: 3px solid var(--primary-color);
    }
    
    .idps-metric .value {
      color: var(--primary-color);
    }
    
    .returnees-metric {
      border-top: 3px solid var(--secondary-color);
    }
    
    .returnees-metric .value {
      color: var(--secondary-color);
    }
    
    .crossing-metric {
      border-top: 3px solid var(--tertiary-color);
    }
    
    .crossing-metric .value {
      color: var(--tertiary-color);
    }
    
    /* Flow direction indicators */
    .flow-direction {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
      background: var(--light-gray);
      border-radius: var(--border-radius-sm);
      padding: 15px 10px;
    }
    
    .flow-item {
      text-align: center;
      flex: 1;
    }
    
    .flow-item .label {
      font-size: 13px;
      font-weight: 500;
      color: var(--dark-gray);
    }
    
    .flow-item .arrow {
      font-size: 20px;
      margin: 5px 0;
    }
    
    .flow-item .value {
      font-size: 18px;
      font-weight: 600;
    }
    
    .inflow .arrow {
      color: var(--success-color);
    }
    
    .outflow .arrow {
      color: var(--warning-color);
    }
    
    /* Chart container */
    .chart-container {
      margin-top: 15px;
      height: 220px;
      position: relative;
    }
    
    /* Time period selector */
    .time-period-selector {
      display: flex;
      background: var(--light-gray);
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      margin-top: 15px;
    }
    
    .time-period-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--dark-gray);
      text-align: center;
      transition: var(--transition);
    }
    
    .time-period-btn.active {
      background: var(--primary-color);
      color: white;
    }
    
    /* Map controls */
    .map-container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    #population-distribution-map,
    #flow-map {
      flex-grow: 1;
      width: 100%;
    }
    
    #flow-map {
      display: none;
    }
    
    .map-controls {
      padding: 15px 25px;
      background-color: white;
      border-bottom: 1px solid var(--medium-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .map-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--darker-gray);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Toggle buttons */
    .population-toggle {
      display: flex;
      background: var(--medium-gray);
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      box-shadow: var(--box-shadow);
    }
    
    .population-toggle .toggle-btn {
      border: none;
      padding: 10px 18px;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: var(--dark-gray);
      transition: var(--transition);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }
  
    .population-toggle .toggle-btn.active {
      background: var(--primary-color);
      color: white;
    }
    
    .population-toggle .toggle-btn:hover:not(.active) {
      background: #d1d9e6;
    }
    
    .toggle-btn i {
      font-size: 16px;
    }
    
    /* Search container */
    .search-container {
      position: relative;
      width: 100%;
    }
    
    #state-search {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--medium-gray);
      border-radius: var(--border-radius-sm);
      font-size: 14px;
      transition: var(--transition);
      background-color: var(--light-gray);
    }
    
    #state-search:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }
    
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--medium-gray);
      border-top: none;
      border-radius: 0 0 var(--border-radius-sm) var(--border-radius-sm);
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: var(--box-shadow);
    }
    
    .search-results div {
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 14px;
    }
    
    .search-results div:hover {
      background-color: var(--light-gray);
    }
    
    /* Buttons */
    .btn {
      padding: 10px 16px;
      border-radius: var(--border-radius-sm);
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .btn-sm {
      padding: 8px 12px;
      font-size: 13px;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #3a56d4;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(67, 97, 238, 0.3);
    }
    
    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--medium-gray);
      color: var(--darker-gray);
    }
    
    .btn-outline:hover {
      background-color: var(--light-gray);
      transform: translateY(-2px);
    }
    
    /* Loading state */
    .map-loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      font-size: 16px;
      color: var(--text-color);
      flex-direction: column;
      gap: 15px;
    }
    
    .map-loading:after {
      content: "";
      width: 40px;
      height: 40px;
      border: 4px solid var(--medium-gray);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Tab controls */
    .map-tabs {
      display: flex;
      background: var(--medium-gray);
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      box-shadow: var(--box-shadow);
      margin-bottom: 15px;
    }
    
    .map-tab {
      padding: 10px 15px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--dark-gray);
      transition: var(--transition);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      flex: 1;
      justify-content: center;
    }
    
    .map-tab.active {
      background: var(--primary-color);
      color: white;
    }
    
    .map-tab:hover:not(.active) {
      background: #d1d9e6;
    }
    
    /* Flow controls */
    .flow-controls {
      display: flex;
      gap: 10px;
      margin-left: auto;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    
    .flow-btn {
      padding: 8px 12px;
      border-radius: var(--border-radius-sm);
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      background-color: var(--light-gray);
      color: var(--dark-gray);
      transition: var(--transition);
    }
    
    .flow-btn:hover {
      background-color: var(--medium-gray);
    }
    
    .flow-btn.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .sidebar-content {
        width: 380px;
        padding: 20px;
      }
    }
    
    @media (max-width: 992px) {
      .sidebar-content {
        display: none;
      }
    }
    
    @media (max-width: 768px) {
      .app-header {
        padding: 0 20px;
      }
      
      .metrics-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .map-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .population-toggle {
        width: 100%;
      }
      
      .flow-controls {
        width: 100%;
        justify-content: space-between;
      }
    }
    
    @media (max-width: 576px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
      
      .header-controls {
        gap: 10px;
      }
    }
  </style>
</head>

<body>
  <header class="app-header">
    <div class="logo-container">
      <div>
        <h1 class="app-title">Sudan Displacement Dashboard</h1>
        <p class="app-subtitle">Tracking population movements and needs</p>
      </div>
    </div>
    <div class="header-controls">
      <button class="btn btn-outline">
        <i class="fas fa-download"></i> Export
      </button>
      <button class="btn btn-primary">
        <i class="fas fa-question-circle"></i> Help
      </button>
    </div>
  </header>
  
  <div class="main-container">
    <div class="sidebar-content">
      <!-- IDPs Section -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-people-arrows"></i> Internally Displaced Persons
          </h2>
          <button class="btn btn-outline btn-sm">
            <i class="fas fa-info-circle"></i> Details
          </button>
        </div>
        
        <div class="section-content">
          <div class="metrics-grid">
            <div class="metric-card idps-metric">
              <div class="label">Total IDPs</div>
              <div class="value">9.84M</div>
              <div class="change negative">
                <i class="fas fa-arrow-up"></i> 12% increase
              </div>
            </div>
            
            <div class="metric-card">
              <div class="label">New This Month</div>
              <div class="value">1.05M</div>
              <div class="sub-value">+82,000 from last week</div>
            </div>
            
            <div class="metric-card">
              <div class="label">Top State</div>
              <div class="value">South Darfur</div>
              <div class="sub-value">1.84M IDPs</div>
            </div>
            
            <div class="metric-card">
              <div class="label">Most Urgent Need</div>
              <div class="value">Shelter</div>
              <div class="sub-value">72% of IDPs</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Returnees Section -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-home"></i> Returnees
          </h2>
          <button class="btn btn-outline btn-sm">
            <i class="fas fa-info-circle"></i> Details
          </button>
        </div>
        
        <div class="section-content">
          <div class="metrics-grid">
            <div class="metric-card returnees-metric">
              <div class="label">Total Returnees</div>
              <div class="value">647,604</div>
              <div class="change positive">
                <i class="fas fa-arrow-down"></i> 5% decrease
              </div>
            </div>
            
            <div class="metric-card">
              <div class="label">New This Month</div>
              <div class="value">32,150</div>
              <div class="sub-value">+2,400 from last week</div>
            </div>
            
            <div class="metric-card">
              <div class="label">Top State</div>
              <div class="value">Aj Jazirah</div>
              <div class="sub-value">486,730 Returnees</div>
            </div>
            
            <div class="metric-card">
              <div class="label">Main Challenge</div>
              <div class="value">Livelihoods</div>
              <div class="sub-value">65% of returnees</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Population Movement Section -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-exchange-alt"></i> Population Movement
          </h2>
          <button class="btn btn-outline btn-sm">
            <i class="fas fa-info-circle"></i> Details
          </button>
        </div>
        
        <div class="section-content">
          <div class="metric-card crossing-metric">
            <div class="label">Total Crossings</div>
            <div class="value">1.24M</div>
            <div class="change negative">
              <i class="fas fa-arrow-up"></i> 8% increase
            </div>
            
            <div class="flow-direction">
              <div class="flow-item inflow">
                <div class="label">Inflow</div>
                <div class="arrow"><i class="fas fa-arrow-down"></i></div>
                <div class="value">842,150</div>
              </div>
              <div class="flow-item outflow">
                <div class="label">Outflow</div>
                <div class="arrow"><i class="fas fa-arrow-up"></i></div>
                <div class="value">403,170</div>
              </div>
            </div>
          </div>
          
          <div class="metrics-grid" style="margin-top: 15px;">
            <div class="metric-card">
              <div class="label">Main Destination</div>
              <div class="value">Chad</div>
              <div class="sub-value">412,500 people</div>
            </div>
            
            <div class="metric-card">
              <div class="label">Main Origin</div>
              <div class="value">West Darfur</div>
              <div class="sub-value">387,200 people</div>
            </div>
            
            <div class="metric-card">
              <div class="label">Border Crossing</div>
              <div class="value">Adré</div>
              <div class="sub-value">Most active</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Trends Section -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-chart-line"></i> Trends Over Time
          </h2>
          <div class="time-period-selector" style="width: auto;">
            <button class="time-period-btn active">3M</button>
            <button class="time-period-btn">6M</button>
            <button class="time-period-btn">1Y</button>
          </div>
        </div>
        
        <div class="section-content">
          <div class="chart-container">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Map Controls Section -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-map-marked-alt"></i> Map Controls
          </h2>
        </div>
        
        <div class="section-content">
          <div class="map-tabs" style="margin-bottom: 15px;">
            <button class="map-tab active" data-tab="population">
              <i class="fas fa-map-marked-alt"></i> Population
            </button>
            <button class="map-tab" data-tab="flow">
              <i class="fas fa-project-diagram"></i> Flow
            </button>
          </div>
          
          <div class="search-container">
            <input type="text" id="state-search" placeholder="Search for a state..." />
            <div class="search-results" id="searchResults"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Map container -->
    <div class="map-container">
      <div class="map-controls">
        <h2 class="map-title" id="mapTitle">
          <i class="fas fa-map-marked-alt"></i> Population Distribution
        </h2>
        <div class="population-toggle" id="populationToggle">
          <button class="toggle-btn active" data-type="idps">
            <i class="fas fa-people-arrows"></i> IDPs
          </button>
          <button class="toggle-btn" data-type="returnees">
            <i class="fas fa-home"></i> Returnees
          </button>
        </div>
        <div class="flow-controls" id="flowControls" style="display: none;">
          <button class="flow-btn" id="resetFlowView">
            <i class="fas fa-globe-africa"></i> Reset
          </button>
          <button class="flow-btn active" id="toggleAnimation">
            <i class="fas fa-play"></i> Play
          </button>
          <button class="flow-btn active" id="toggleFlows">
            <i class="fas fa-wave-square"></i> Flows
          </button>
          <button class="flow-btn active" id="togglePoints">
            <i class="fas fa-map-marker-alt"></i> Points
          </button>
        </div>
      </div>
      <div id="population-distribution-map"></div>
      <div id="flow-map"></div>
      <div id="map-loading" class="map-loading">Loading map data...</div>
    </div>
  </div>

  <script>
    // Global variables
    let populationMap, flowMap;
    let geojsonLayer, flowmapLayer;
    let currentDataType = 'idps';
    let isAnimationPlaying = false;
    let showFlows = true;
    let showPoints = true;
    let sudanStatesData;
    let trendChart;
    let stateDisplacementChart;

    // State displacement data
    const stateDisplacementData = {
      "Aj Jazirah": { code: "SD15", idps: 139842, returnees: 952275 },
      "Blue Nile": { code: "SD08", idps: 405553, returnees: 0 },
      "Central Darfur": { code: "SD06", idps: 970797, returnees: 0 },
      "East Darfur": { code: "SD05", idps: 802944, returnees: 0 },
      "Gedaref": { code: "SD12", idps: 475315, returnees: 0 },
      "Kassala": { code: "SD11", idps: 118605, returnees: 0 },
      "Khartoum": { code: "SD01", idps: 230326, returnees: 105723 },
      "North Darfur": { code: "SD02", idps: 1794860, returnees: 0 },
      "North Kordofan": { code: "SD13", idps: 218478, returnees: 0 },
      "Northern": { code: "SD17", idps: 530127, returnees: 0 },
      "Red Sea": { code: "SD10", idps: 178582, returnees: 0 },
      "River Nile": { code: "SD16", idps: 585975, returnees: 28655 },
      "Sennar": { code: "SD14", idps: 92484, returnees: 178107 },
      "South Darfur": { code: "SD03", idps: 1842960, returnees: 0 },
      "South Kordofan": { code: "SD07", idps: 392118, returnees: 0 },
      "West Darfur": { code: "SD04", idps: 347342, returnees: 2005 },
      "West Kordofan": { code: "SD18", idps: 395260, returnees: 0 },
      "White Nile": { code: "SD09", idps: 543761, returnees: 70352 }
    };

    // Initialize the dashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      initPopulationDistributionMap();
      setupEventListeners();
    });

    // Initialize the Population Distribution map
    async function initPopulationDistributionMap() {
      try {
        // Show loading state
        document.getElementById('map-loading').style.display = 'flex';
        
        // Initialize charts
        initTrendChart();
        
        // Load GeoJSON data
        const response = await fetch('./data/ADMIN1.json');
        if (!response.ok) throw new Error(`Failed to load GeoJSON data: ${response.status}`);
        sudanStatesData = await response.json();
        
        // Initialize the population map
        populationMap = L.map('population-distribution-map', {
          zoomControl: false,
          attributionControl: false
        }).setView([16, 30], L.Browser.mobile ? 3 : 6);
        
        // Add zoom control
        L.control.zoom({ position: 'topright' }).addTo(populationMap);
        
        // Add base layers
        const mapboxCustom = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
          attribution: '© Mapbox © OpenStreetMap',
          tileSize: 512,
          zoomOffset: -1,
          maxZoom: 18
        }).addTo(populationMap);
        
        // Add GeoJSON layer
        geojsonLayer = L.geoJSON(sudanStatesData, {
          style: getStyle,
          onEachFeature: onEachFeature
        }).addTo(populationMap);
        
        // Fit map to bounds
        populationMap.fitBounds(geojsonLayer.getBounds(), { padding: [50, 50] });
        
        // Add info control
        const info = L.control({position: 'topleft'});
        info.onAdd = function() {
          this._div = L.DomUtil.create('div', 'info');
          this.update();
          return this._div;
        };
        info.update = function(props) {
          const title = currentDataType === 'idps' ? 'IDP Distribution' : 'Returnee Distribution';
          const valueLabel = currentDataType === 'idps' ? 'IDPs' : 'Returnees';
          this._div.innerHTML = `<h4>Sudan ${title}</h4>` + (props ? 
            `<b>${props.state}</b><br />${(props[`total_${currentDataType}`] || 0).toLocaleString()} ${valueLabel}` : 
            'Hover over a state');
        };
        info.addTo(populationMap);
        
        // Add legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function() {
          const div = L.DomUtil.create('div', 'info legend');
          const grades = [0, 50000, 100000, 200000, 500000, 1000000];
          const title = currentDataType === 'idps' ? 'IDPs' : 'Returnees';
          
          div.innerHTML = `<h4>${title}</h4>`;
          for (let i = 0; i < grades.length; i++) {
            div.innerHTML += '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
              grades[i].toLocaleString() + (grades[i + 1] ? '&ndash;' + grades[i + 1].toLocaleString() + '<br>' : '+');
          }
          return div;
        };
        legend.addTo(populationMap);
        
        // Hide loading state
        document.getElementById('map-loading').style.display = 'none';
        
      } catch (error) {
        console.error("Error initializing map:", error);
        document.getElementById('map-loading').innerHTML = 'Error loading map data';
      }
    }

    // Initialize trend chart
    function initTrendChart() {
      const ctx = document.getElementById('trendChart').getContext('2d');
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Mar', 'Apr', 'May', 'Jun'],
          datasets: [
            {
              label: 'IDPs',
              data: [8000000, 8500000, 9200000, 9842000],
              borderColor: '#4361ee',
              backgroundColor: 'rgba(67, 97, 238, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true
            },
            {
              label: 'Returnees',
              data: [550000, 600000, 620000, 647604],
              borderColor: '#f72585',
              backgroundColor: 'rgba(247, 37, 133, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: getChartOptions()
      });
    }

    // Get chart options
    function getChartOptions() {
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: function(context) {
                return `${context.dataset.label}: ${context.raw.toLocaleString()}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            ticks: {
              callback: function(value) {
                if (value >= 1000000) return `${(value / 1000000).toFixed(1)}M`;
                if (value >= 1000) return `${(value / 1000).toFixed(0)}K`;
                return value;
              }
            },
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          },
          x: { grid: { display: false } }
        },
        interaction: { mode: 'nearest', axis: 'x', intersect: false }
      };
    }

    // Get style for GeoJSON features
    function getStyle(feature) {
      return {
        fillColor: getColor(feature.properties[`total_${currentDataType}`] || 0),
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
      };
    }

    // Get color based on value
    function getColor(d) {
      if (currentDataType === 'idps') {
        return d > 1000000 ? '#1e3a8a' :
               d > 500000  ? '#1e40af' :
               d > 200000  ? '#1d4ed8' :
               d > 100000  ? '#3b82f6' :
               d > 50000   ? '#93c5fd' :
               d > 20000   ? '#bfdbfe' :
                             '#dbeafe';
      } else {
        return d > 1000000 ? 'rgba(247, 37, 133, 0.9)' :
               d > 500000  ? 'rgba(247, 37, 133, 0.8)' :
               d > 200000  ? 'rgba(247, 37, 133, 0.7)' :
               d > 100000  ? 'rgba(247, 37, 133, 0.6)' :
               d > 50000   ? 'rgba(247, 37, 133, 0.5)' :
               d > 20000   ? 'rgba(247, 37, 133, 0.4)' :
                             'rgba(247, 37, 133, 0.3)';
      }
    }

    // Feature event handlers
    function onEachFeature(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: zoomToFeature
      });
    }

    function highlightFeature(e) {
      const layer = e.target;
      layer.setStyle({
        weight: 5,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.7
      });
      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
      }
      updateTrendChart(layer.feature.properties);
    }

    function resetHighlight(e) {
      geojsonLayer.resetStyle(e.target);
      resetTrendChart();
    }

    function zoomToFeature(e) {
      populationMap.fitBounds(e.target.getBounds(), {
        padding: [50, 50],
        maxZoom: 8
      });
    }

    function updateTrendChart(props) {
      if (!props || !props.trend) return;
      trendChart.data.datasets[0].data = props.trend;
      trendChart.data.datasets[1].data = [];
      trendChart.update();
    }

    function resetTrendChart() {
      trendChart.data.datasets[0].data = [8000000, 8500000, 9200000, 9842000];
      trendChart.data.datasets[1].data = [550000, 600000, 620000, 647604];
      trendChart.update();
    }

    // Initialize flow map
    function initFlowMap() {
      if (flowMap) return;
      
      try {
        document.getElementById('map-loading').style.display = 'flex';
        
        flowMap = L.map('flow-map', {
          zoomControl: false,
          attributionControl: false
        }).setView([16, 30], 5.5);
        
        L.control.zoom({ position: 'topright' }).addTo(flowMap);
        
        const mapboxCustom = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
          attribution: '© Mapbox © OpenStreetMap',
          tileSize: 512,
          zoomOffset: -1,
          maxZoom: 18
        }).addTo(flowMap);
        
        if (sudanStatesData) {
          L.geoJSON(sudanStatesData, {
            style: {
              color: '#555',
              weight: 1,
              opacity: 0.7,
              fillOpacity: 0.1
            }
          }).addTo(flowMap);
        }
        
        Papa.parse('./data/IDPs_Pathway.csv', {
          download: true,
          header: true,
          complete: function(results) {
            initializeFlowmapLayer(processFlowData(results.data));
            document.getElementById('map-loading').style.display = 'none';
          },
          error: function(error) {
            console.error('Error loading flow data:', error);
            document.getElementById('map-loading').innerHTML = 'Error loading flow data';
          }
        });
        
      } catch (error) {
        console.error("Error initializing flow map:", error);
        document.getElementById('map-loading').innerHTML = 'Error loading flow map';
      }
    }

    // Process flow data
    function processFlowData(data) {
      return {
        type: 'FeatureCollection',
        features: data.map(datum => ({
          type: 'Feature',
          geometry: { 
            type: 'Point', 
            coordinates: [parseFloat(datum.s_lon) || 0, parseFloat(datum.s_lat) || 0] 
          },
          properties: {
            s_state_id: datum.s_state_id,
            s_State: datum.s_State,
            s_lat: parseFloat(datum.s_lat) || 0,
            s_lon: parseFloat(datum.s_lon) || 0,
            e_locality_id: datum.e_locality_id,
            e_locality: datum.e_locality,
            e_lat: parseFloat(datum.e_lat) || 0,
            e_lon: parseFloat(datum.e_lon) || 0,
            e_Volume: parseFloat(datum.e_Volume) || 0,
            main_needs: datum.main_needs
          }
        }))
      };
    }

    // Initialize flowmap layer
    function initializeFlowmapLayer(data) {
      flowmapLayer = L.canvasFlowmapLayer(data, {
        originAndDestinationFieldIds: {
          originUniqueIdField: 's_state_id',
          originGeometry: { x: 's_lon', y: 's_lat' },
          destinationUniqueIdField: 'e_locality_id',
          destinationGeometry: { x: 'e_lon', y: 'e_lat' }
        },
        style: (feature) => ({
          radius: feature.properties.isOrigin ? 10 : Math.min(10 + (feature.properties.e_Volume / 5000), 6),
          weight: 1,
          color: '#fff',
          fillColor: feature.properties.isOrigin ? '#f72585' : '#4361ee',
          fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
        }),
        pathDisplayMode: 'all',
        animationStarted: true,
        onEachFeature: addFlowTooltip
      }).addTo(flowMap);
      
      // Set initial UI states
      isAnimationPlaying = true;
      showFlows = true;
      showPoints = true;
      updateAnimationButton();
      updateFlowsButton();
      updatePointsButton();
      
      // Highlight paths on mouseover
      flowmapLayer.on('mouseover', (e) => {
        if (e.sharedOriginFeatures.length) flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
        if (e.sharedDestinationFeatures.length) flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
      });
      
      // Select initial feature
      flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
    }

    // Add flow tooltip
    function addFlowTooltip(feature, layer) {
      const tooltipContent = feature.properties.isOrigin ? 
        `Displacement From: ${feature.properties.s_State}` : 
        `Displacement To: ${feature.properties.e_locality}`;
      
      layer.bindTooltip(tooltipContent);
      layer.on('mouseover', () => layer.openTooltip());
      layer.on('mouseout', () => layer.closeTooltip());
      
      const popupContent = feature.properties.isOrigin ?
        `<div style="min-width: 200px;">
           <h4 style="margin: 0 0 10px; color: #2a5885;">Displacement Origin</h4>
           <p><strong>State:</strong> ${feature.properties.s_State}</p>
           <p><strong>Main Needs:</strong> ${feature.properties.main_needs || 'Not specified'}</p>
         </div>` :
        `<div style="min-width: 200px;">
           <h4 style="margin: 0 0 10px; color: #2a5885;">Displacement Destination</h4>
           <p><strong>Location:</strong> ${feature.properties.e_locality}</p>
           <p><strong>Total Displaced:</strong> ${feature.properties.e_Volume?.toLocaleString() || 'N/A'}</p>
         </div>`;
      
      layer.bindPopup(popupContent);
    }

    // Setup event listeners
    function setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.map-tab').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.map-tab').forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          const tab = button.dataset.tab;
          if (tab === 'population') {
            document.getElementById('population-distribution-map').style.display = 'block';
            document.getElementById('flow-map').style.display = 'none';
            document.getElementById('populationToggle').style.display = 'flex';
            document.getElementById('flowControls').style.display = 'none';
            document.getElementById('mapTitle').innerHTML = '<i class="fas fa-map-marked-alt"></i> Population Distribution';
          } else if (tab === 'flow') {
            document.getElementById('population-distribution-map').style.display = 'none';
            document.getElementById('flow-map').style.display = 'block';
            document.getElementById('populationToggle').style.display = 'none';
            document.getElementById('flowControls').style.display = 'flex';
            document.getElementById('mapTitle').innerHTML = '<i class="fas fa-project-diagram"></i> IDP Pathways';
            initFlowMap();
          }
        });
      });
      
      // Population type toggle
      document.querySelectorAll('.population-toggle .toggle-btn').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.population-toggle .toggle-btn').forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          currentDataType = button.dataset.type;
          geojsonLayer.setStyle(getStyle);
        });
      });
      
      // Flow controls
      document.getElementById('resetFlowView').addEventListener('click', () => flowMap.setView([16, 30], 5.5));
      
      document.getElementById('toggleAnimation').addEventListener('click', function() {
        isAnimationPlaying = !isAnimationPlaying;
        this.classList.toggle('active');
        flowmapLayer.setAnimationStarted(isAnimationPlaying);
        updateAnimationButton();
      });
      
      document.getElementById('toggleFlows').addEventListener('click', function() {
        showFlows = !showFlows;
        this.classList.toggle('active');
        flowmapLayer.setPathDisplayMode(showFlows ? 'all' : 'none');
        updateFlowsButton();
      });
      
      document.getElementById('togglePoints').addEventListener('click', function() {
        showPoints = !showPoints;
        this.classList.toggle('active');
        flowmapLayer.setPointVisibility(showPoints);
        updatePointsButton();
      });
      
      // Search functionality
      const stateSearch = document.getElementById('state-search');
      const searchResults = document.getElementById('searchResults');
      
      if (stateSearch && searchResults) {
        stateSearch.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          if (searchTerm.length < 2) {
            searchResults.style.display = 'none';
            return;
          }
          
          const matchingFeatures = sudanStatesData.features.filter(feature => 
            feature.properties.state.toLowerCase().includes(searchTerm));
          
          if (matchingFeatures.length > 0) {
            searchResults.innerHTML = matchingFeatures.map(feature => 
              `<div data-state="${feature.properties.state}">${feature.properties.state}</div>`
            ).join('');
            searchResults.style.display = 'block';
          } else {
            searchResults.innerHTML = '<div>No matching states found</div>';
            searchResults.style.display = 'block';
          }
        });
        
        searchResults.addEventListener('click', function(e) {
          if (e.target.tagName === 'DIV' && e.target.dataset.state) {
            const stateName = e.target.dataset.state;
            stateSearch.value = stateName;
            searchResults.style.display = 'none';
            
            const feature = sudanStatesData.features.find(f => f.properties.state === stateName);
            if (feature) {
              const layer = geojsonLayer.getLayers().find(l => l.feature.properties.state === stateName);
              if (layer) {
                populationMap.fitBounds(layer.getBounds(), { padding: [50, 50], maxZoom: 8 });
                layer.fire('mouseover');
              }
            }
          }
        });
        
        document.addEventListener('click', function(e) {
          if (e.target !== stateSearch) searchResults.style.display = 'none';
        });
      }
    }

    // Update button states
    function updateAnimationButton() {
      const button = document.getElementById('toggleAnimation');
      button.innerHTML = isAnimationPlaying ? 
        '<i class="fas fa-pause"></i> Pause' : 
        '<i class="fas fa-play"></i> Play';
    }

    function updateFlowsButton() {
      const button = document.getElementById('toggleFlows');
      button.innerHTML = `<i class="fas fa-wave-square"></i> ${showFlows ? 'Hide' : 'Show'} Flows`;
    }

    function updatePointsButton() {
      const button = document.getElementById('togglePoints');
      button.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${showPoints ? 'Hide' : 'Show'} Points`;
    }
  </script>
</body>
</html>
